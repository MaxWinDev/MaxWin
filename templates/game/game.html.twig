{#{% extends 'base.html.twig' %}#}
{#{% block stylesheets %}#}
{#    <link rel="stylesheet" href="{{ asset('css/game.css') }}" type="text/css">#}
{#    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />#}
{#{% endblock %}#}

{#{% block javascripts %}#}
{#    <script src="{{ asset('js/game.js') }}"></script>#}
{#{% endblock %}#}

{#{% block title %}#}
{#    Casino Game#}
{#{% endblock %}#}

{#{% block body %}#}
{#    <div class="background-image"></div>#}
{#    <div class="content">#}
{#        <div class="game-container">#}
{#            <div class="grid">#}
{#                {% for col in 0..4 %}#}
{#                    <div class="column">#}
{#                        {% for row in 0..20 %}#}
{#                            <div class="grid-item">#}
{#                                {% set randomIndex = random(0, gridImages|length - 1) %}#}
{#                                <img src="{{ asset('../assets/images/' ~ gridImages[randomIndex]) }}" alt="Casino Image">#}
{#                            </div>#}
{#                        {% endfor %}#}
{#                    </div>#}
{#                {% endfor %}#}
{#            </div>#}
{#        </div>#}
{#        <div class="spin-container">#}
{#            <button class="auto-spin-button">#}
{#                <span class="material-symbols-outlined">#}
{#                    hdr_auto#}
{#                </span>#}
{#            </button>#}
{#            <button id="spin-button" class="spin-button">#}
{#                <span class="material-symbols-outlined">#}
{#                    autorenew#}
{#                </span>#}
{#            </button>#}
{#            <button class="fast-spin-button">#}
{#                <span class="material-symbols-outlined">#}
{#                    offline_bolt#}
{#                </span>#}
{#            </button>#}
{#        </div>#}
{#    </div>#}
{#{% endblock %}#}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Casino</title>
    <style>
        canvas {
            border: 1px solid black;
            display: block;
            margin: 0 auto;
        }
        #spin {
            display: block;
            margin: 20px auto;
        }
    </style>
</head>
<body>
<canvas id="casinoCanvas" width="500" height="300"></canvas>
<button id="spin">Spin</button>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const canvas = document.getElementById('casinoCanvas');
        const ctx = canvas.getContext('2d');
        const cols = 5;
        const rows = 3;
        const colWidth = canvas.width / cols;
        const rowHeight = canvas.height / rows;
        const symbols = [
        '../assets/images/cerise.png',
        '../assets/images/citron.png',
        '../assets/images/pasteque.png',
        '../assets/images/gold.png',
        '../assets/images/7.png',
        '../assets/images/max.png',
        '../assets/images/prune.png',
        '../assets/images/fraise.png',];
        const images = [];
        let positions = Array.from({ length: cols }, () => Math.floor(Math.random() * symbols.length));
        let speeds = Array(cols).fill(0);
        let spinning = Array(cols).fill(false);

        function loadImages(callback) {
            let loadedImages = 0;
            for (let i = 0; i < symbols.length; i++) {
                images[i] = new Image();
                images[i].src = '/images/' + symbols[i];
                images[i].onload = () => {
                    loadedImages++;
                    if (loadedImages === symbols.length) {
                        callback();
                    }
                };
            }
        }

        function drawGrid() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let col = 0; col < cols; col++) {
                for (let row = 0; row < rows + 2; row++) { // draw an extra row for smooth scrolling
                    const yPos = (positions[col] + row) % symbols.length;
                    const imgIndex = Math.floor(yPos) % symbols.length;
                    const img = images[imgIndex];
                    const yOffset = (positions[col] % 1) * rowHeight;
                    ctx.drawImage(img, col * colWidth, canvas.height - (row + 1) * rowHeight + yOffset, colWidth, rowHeight);
                }
            }
            // Draw column separators
            for (let col = 1; col < cols; col++) {
                ctx.beginPath();
                ctx.moveTo(col * colWidth, 0);
                ctx.lineTo(col * colWidth, canvas.height);
                ctx.stroke();
            }
        }

        function spinColumn(col, stopDelay) {
            return new Promise((resolve) => {
                let stop = false;
                spinning[col] = true;
                speeds[col] = 1; // initial speed
                const spinInterval = setInterval(() => {
                    if (stop) {
                        clearInterval(spinInterval);
                        spinning[col] = false;
                        positions[col] = Math.floor(positions[col]) % symbols.length; // align symbols
                        drawGrid();
                        resolve();
                        return;
                    }
                    positions[col] += speeds[col]; // control speed of spin
                    if (speeds[col] > 0.1) { // gradually slow down
                        speeds[col] *= 0.97; // deceleration factor
                    } else {
                        speeds[col] = 0;
                        stop = true;
                    }
                    drawGrid();
                }, 20);

                setTimeout(() => {
                    stop = true;
                }, stopDelay);
            });
        }

        document.getElementById('spin').addEventListener('click', async () => {
            if (spinning.some(s => s)) return; // prevent multiple spins

            // Start spinning all columns at once
            const promises = [];
            for (let col = 0; col < cols; col++) {
                const stopDelay = col > 0 ? 1000 + col * 500 : 1000; // adjust stop delay based on column index
                promises.push(spinColumn(col, stopDelay));
            }

            // Wait for all columns to stop spinning
            await Promise.all(promises);
        });

        loadImages(drawGrid);
    });
</script>
</body>
</html>





{#const symbols = [#}
{#'../assets/images/cerise.png',#}
{#'../assets/images/citron.png',#}
{#'../assets/images/pasteque.png',#}
{#'../assets/images/gold.png',#}
{#'../assets/images/7.png',#}
{#'../assets/images/max.png',#}
{#'../assets/images/prune.png',#}
{#'../assets/images/fraise.png',];#}